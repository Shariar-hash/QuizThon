<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>User Profile - QuizThon</title>
    <meta name="title" content="User Profile - QuizThon">
    <meta name="description" content="View your QuizThon profile, track your quiz statistics, scores, and progress across different categories.">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://quizthon.com/profile">
    
    <link rel="stylesheet" href="style/styles.css" />
</head>
<body>
    <div class="container">
        <div class="profile-page">
            <div class="profile-header">
                <button class="back-btn" onclick="goBack()">‚Üê Back to Quiz</button>
                <h1>üë§ User Profile</h1>
            </div>
            
            <div class="profile-content">
                <div class="profile-card">
                    <div class="profile-info">
                        <div class="avatar-section" id="avatarSection">
                            <!-- Profile avatar will be loaded here -->
                        </div>
                        <div class="user-details">
                            <h2 id="userName">Loading...</h2>
                            <p id="userEmail" class="email">Loading...</p>
                            <p id="authProvider" class="auth-method">Loading...</p>
                        </div>
                    </div>
                    
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="totalQuizzes">0</span>
                            <span class="stat-label">Total Quizzes</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="averageScore">0%</span>
                            <span class="stat-label">Average Score</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="bestScore">0%</span>
                            <span class="stat-label">Best Score</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="joinDate">-</span>
                            <span class="stat-label">Member Since</span>
                        </div>
                    </div>
                </div>
                
                <div class="quiz-history-section">
                    <h3>üìä Quiz History</h3>
                    <div id="quizHistory" class="quiz-history">
                        <p class="loading">Loading quiz history...</p>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <button class="btn secondary" onclick="changePassword()">üîí Change Password</button>
                    <button class="btn danger" onclick="logout()">üö™ Logout</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        const SERVER_BASE = 'http://localhost:3000/api';

        // Initialize profile page
        document.addEventListener('DOMContentLoaded', function() {
            if (!authToken) {
                alert('You need to be logged in to view this page.');
                window.location.href = 'index.html';
                return;
            }
            loadUserProfile();
        });

        async function loadUserProfile() {
            try {
                const response = await fetch(`${SERVER_BASE}/auth/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.user;
                    displayUserProfile();
                    loadQuizHistory();
                } else {
                    alert('Failed to load profile. Please login again.');
                    localStorage.removeItem('authToken');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Failed to load profile. Please try again.');
            }
        }

        function displayUserProfile() {
            // Display avatar
            const avatarSection = document.getElementById('avatarSection');
            if (currentUser.avatar) {
                avatarSection.innerHTML = `<img src="${currentUser.avatar}" alt="${currentUser.name}" class="profile-avatar-large">`;
            } else {
                avatarSection.innerHTML = `<div class="profile-avatar-large default">${currentUser.name.charAt(0).toUpperCase()}</div>`;
            }

            // Display user details
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('authProvider').textContent = 
                `Signed in with ${currentUser.authProvider === 'google' ? 'Google' : 'Email/Password'}`;

            // Calculate and display stats
            const quizHistory = currentUser.quizHistory || [];
            const totalQuizzes = quizHistory.length;
            
            let averageScore = 0;
            let bestScore = 0;
            
            if (totalQuizzes > 0) {
                const totalScore = quizHistory.reduce((sum, quiz) => sum + quiz.score, 0);
                averageScore = Math.round(totalScore / totalQuizzes);
                bestScore = Math.max(...quizHistory.map(quiz => quiz.score));
            }

            document.getElementById('totalQuizzes').textContent = totalQuizzes;
            document.getElementById('averageScore').textContent = `${averageScore}%`;
            document.getElementById('bestScore').textContent = `${bestScore}%`;
            document.getElementById('joinDate').textContent = new Date(currentUser.createdAt || Date.now()).toLocaleDateString();
        }

        function loadQuizHistory() {
            const historyContainer = document.getElementById('quizHistory');
            const quizHistory = currentUser.quizHistory || [];

            if (quizHistory.length === 0) {
                historyContainer.innerHTML = '<p class="no-history">No quiz history yet. Start taking quizzes to see your progress!</p>';
                return;
            }

            // Sort by date (most recent first)
            quizHistory.sort((a, b) => new Date(b.dateTaken) - new Date(a.dateTaken));

            const historyHTML = quizHistory.map(quiz => `
                <div class="history-item">
                    <div class="quiz-info">
                        <h4>${quiz.category}</h4>
                        <p class="quiz-details">${quiz.difficulty} ‚Ä¢ ${quiz.questionsCount} questions</p>
                        <p class="quiz-date">${new Date(quiz.dateTaken).toLocaleDateString()}</p>
                    </div>
                    <div class="quiz-score ${quiz.score >= 80 ? 'excellent' : quiz.score >= 60 ? 'good' : 'needs-improvement'}">
                        ${quiz.score}%
                    </div>
                </div>
            `).join('');

            historyContainer.innerHTML = historyHTML;
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        function changePassword() {
            if (currentUser.authProvider === 'google') {
                alert('You signed in with Google. Password changes should be done through your Google account.');
                return;
            }
            
            const newPassword = prompt('Enter your new password:');
            if (newPassword && newPassword.length >= 6) {
                // Implement password change functionality
                alert('Password change functionality will be implemented soon.');
            } else if (newPassword !== null) {
                alert('Password must be at least 6 characters long.');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('authToken');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
